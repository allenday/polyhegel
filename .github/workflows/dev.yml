name: Dev Branch CI

on:
  push:
    branches: [ dev ]

env:
  PYTHONPATH: ${{ github.workspace }}
  PYTEST_ADDOPTS: "-v --tb=short"
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Fast linting check - runs first for quick feedback
  linting:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    - run: make ci-setup ci-deps lint

  # Type checking - runs in parallel with linting
  typecheck:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    - run: make ci-setup ci-deps typecheck

  # Unit tests - runs after linting and typecheck pass
  unit-tests:
    runs-on: ubuntu-latest
    needs: [linting, typecheck]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    - run: make ci-setup ci-deps test-no-llm

  # Build verification - runs in parallel with unit tests
  build-check:
    runs-on: ubuntu-latest
    needs: [linting, typecheck]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    - run: make ci-setup && pip install build && make build

  # Summary job - provides overall status
  dev-summary:
    runs-on: ubuntu-latest
    needs: [linting, typecheck, unit-tests, build-check]
    if: always()
    steps:
    - name: Dev CI Summary
      run: |
        echo "## 🚀 Dev Branch CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Linting**: ${{ needs.linting.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Type Check**: ${{ needs.typecheck.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Unit Tests**: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: ${{ needs.build-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: dev (fast feedback mode)" >> $GITHUB_STEP_SUMMARY
        
        # Check if any job failed
        if [[ "${{ needs.linting.result }}" == "failure" || "${{ needs.typecheck.result }}" == "failure" || "${{ needs.unit-tests.result }}" == "failure" || "${{ needs.build-check.result }}" == "failure" ]]; then
          echo "❌ Some checks failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "✅ All checks passed" >> $GITHUB_STEP_SUMMARY
        fi